use hex;
use std::fmt;

macro_rules! push_extra_data {
    ($self:expr, $stream:expr, $( $push:ident ),*) => {
        match $self {
            $(
                Opcode::$push(bytes) => $stream.extend_from_slice(bytes),
            )*
            _ => {}
        }
    };
}

macro_rules! push_match_formats {
    ( $( $push:ident ),*) => {
        fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {
            match self {
                $(
                    $push(d) => write!(f, "{} 0x{}", stringify!($push), hex::encode(&d)),
                )*
                _ => write!(f, "{:?}", self)
            }
        }
    };
}

#[derive(Clone, Copy, Debug, PartialEq, Eq)]
#[allow(dead_code)]
pub enum Opcode {
    STOP,
    ADD,
    MUL,
    SUB,
    DIV,
    SDIV,
    MOD,
    SMOD,
    ADDMOD,
    MULMOD,
    EXP,
    SIGNEXTEND,
    LT,
    GT,
    SLT,
    SGT,
    EQ,
    ISZERO,
    AND,
    OR,
    XOR,
    NOT,
    BYTE,
    SHL,
    SHR,
    SAR,
    SHA3,
    ADDRESS,
    BALANCE,
    ORIGIN,
    CALLER,
    CALLVALUE,
    CALLDATALOAD,
    CALLDATASIZE,
    CALLDATACOPY,
    CODESIZE,
    CODECOPY,
    GASPRICE,
    EXTCODESIZE,
    EXTCODECOPY,
    RETURNDATASIZE,
    RETURNDATACOPY,
    EXTCODEHASH,
    BLOCKHASH,
    COINBASE,
    TIMESTAMP,
    NUMBER,
    DIFFICULTY,
    GASLIMIT,
    CHAINID,
    SELFBALANCE,
    BASEFEE,
    POP,
    MLOAD,
    MSTORE,
    MSTORE8,
    SLOAD,
    SSTORE,
    JUMP,
    JUMPI,
    PC,
    MSIZE,
    GAS,
    JUMPDEST,
    PUSH0,
    PUSH1([u8; 1]),
    PUSH2([u8; 2]),
    PUSH3([u8; 3]),
    PUSH4([u8; 4]),
    PUSH5([u8; 5]),
    PUSH6([u8; 6]),
    PUSH7([u8; 7]),
    PUSH8([u8; 8]),
    PUSH9([u8; 9]),
    PUSH10([u8; 10]),
    PUSH11([u8; 11]),
    PUSH12([u8; 12]),
    PUSH13([u8; 13]),
    PUSH14([u8; 14]),
    PUSH15([u8; 15]),
    PUSH16([u8; 16]),
    PUSH17([u8; 17]),
    PUSH18([u8; 18]),
    PUSH19([u8; 19]),
    PUSH20([u8; 20]),
    PUSH21([u8; 21]),
    PUSH22([u8; 22]),
    PUSH23([u8; 23]),
    PUSH24([u8; 24]),
    PUSH25([u8; 25]),
    PUSH26([u8; 26]),
    PUSH27([u8; 27]),
    PUSH28([u8; 28]),
    PUSH29([u8; 29]),
    PUSH30([u8; 30]),
    PUSH31([u8; 31]),
    PUSH32([u8; 32]),
    DUP1,
    DUP2,
    DUP3,
    DUP4,
    DUP5,
    DUP6,
    DUP7,
    DUP8,
    DUP9,
    DUP10,
    DUP11,
    DUP12,
    DUP13,
    DUP14,
    DUP15,
    DUP16,
    SWAP1,
    SWAP2,
    SWAP3,
    SWAP4,
    SWAP5,
    SWAP6,
    SWAP7,
    SWAP8,
    SWAP9,
    SWAP10,
    SWAP11,
    SWAP12,
    SWAP13,
    SWAP14,
    SWAP15,
    SWAP16,
    LOG0,
    LOG1,
    LOG2,
    LOG3,
    LOG4,
    CREATE,
    CALL,
    CALLCODE,
    RETURN,
    DELEGATECALL,
    CREATE2,
    STATICCALL,
    REVERT,
    INVALID,
    SELFDESTRUCT,

    UNKNOWN(u8),
}

use Opcode::*;

impl Opcode {
    pub fn byte(&self) -> u8 {
        match &self {
            STOP => 0x00,
            ADD => 0x01,
            MUL => 0x02,
            SUB => 0x03,
            DIV => 0x04,
            SDIV => 0x05,
            MOD => 0x06,
            SMOD => 0x07,
            ADDMOD => 0x08,
            MULMOD => 0x09,
            EXP => 0x0A,
            SIGNEXTEND => 0x0B,
            LT => 0x10,
            GT => 0x11,
            SLT => 0x12,
            SGT => 0x13,
            EQ => 0x14,
            ISZERO => 0x15,
            AND => 0x16,
            OR => 0x17,
            XOR => 0x18,
            NOT => 0x19,
            BYTE => 0x1A,
            SHL => 0x1B,
            SHR => 0x1C,
            SAR => 0x1D,
            SHA3 => 0x20,
            ADDRESS => 0x30,
            BALANCE => 0x31,
            ORIGIN => 0x32,
            CALLER => 0x33,
            CALLVALUE => 0x34,
            CALLDATALOAD => 0x35,
            CALLDATASIZE => 0x36,
            CALLDATACOPY => 0x37,
            CODESIZE => 0x38,
            CODECOPY => 0x39,
            GASPRICE => 0x3A,
            EXTCODESIZE => 0x3B,
            EXTCODECOPY => 0x3C,
            RETURNDATASIZE => 0x3D,
            RETURNDATACOPY => 0x3E,
            EXTCODEHASH => 0x3F,
            BLOCKHASH => 0x40,
            COINBASE => 0x41,
            TIMESTAMP => 0x42,
            NUMBER => 0x43,
            DIFFICULTY => 0x44,
            GASLIMIT => 0x45,
            CHAINID => 0x46,
            SELFBALANCE => 0x47,
            BASEFEE => 0x48,
            POP => 0x50,
            MLOAD => 0x51,
            MSTORE => 0x52,
            MSTORE8 => 0x53,
            SLOAD => 0x54,
            SSTORE => 0x55,
            JUMP => 0x56,
            JUMPI => 0x57,
            PC => 0x58,
            MSIZE => 0x59,
            GAS => 0x5A,
            JUMPDEST => 0x5B,
            PUSH0 => 0x5F,
            PUSH1(_) => 0x60,
            PUSH2(_) => 0x61,
            PUSH3(_) => 0x62,
            PUSH4(_) => 0x63,
            PUSH5(_) => 0x64,
            PUSH6(_) => 0x65,
            PUSH7(_) => 0x66,
            PUSH8(_) => 0x67,
            PUSH9(_) => 0x68,
            PUSH10(_) => 0x69,
            PUSH11(_) => 0x6A,
            PUSH12(_) => 0x6B,
            PUSH13(_) => 0x6C,
            PUSH14(_) => 0x6D,
            PUSH15(_) => 0x6E,
            PUSH16(_) => 0x6F,
            PUSH17(_) => 0x70,
            PUSH18(_) => 0x71,
            PUSH19(_) => 0x72,
            PUSH20(_) => 0x73,
            PUSH21(_) => 0x74,
            PUSH22(_) => 0x75,
            PUSH23(_) => 0x76,
            PUSH24(_) => 0x77,
            PUSH25(_) => 0x78,
            PUSH26(_) => 0x79,
            PUSH27(_) => 0x7A,
            PUSH28(_) => 0x7B,
            PUSH29(_) => 0x7C,
            PUSH30(_) => 0x7D,
            PUSH31(_) => 0x7E,
            PUSH32(_) => 0x7F,
            DUP1 => 0x80,
            DUP2 => 0x81,
            DUP3 => 0x82,
            DUP4 => 0x83,
            DUP5 => 0x84,
            DUP6 => 0x85,
            DUP7 => 0x86,
            DUP8 => 0x87,
            DUP9 => 0x88,
            DUP10 => 0x89,
            DUP11 => 0x8A,
            DUP12 => 0x8B,
            DUP13 => 0x8C,
            DUP14 => 0x8D,
            DUP15 => 0x8E,
            DUP16 => 0x8F,
            SWAP1 => 0x90,
            SWAP2 => 0x91,
            SWAP3 => 0x92,
            SWAP4 => 0x93,
            SWAP5 => 0x94,
            SWAP6 => 0x95,
            SWAP7 => 0x96,
            SWAP8 => 0x97,
            SWAP9 => 0x98,
            SWAP10 => 0x99,
            SWAP11 => 0x9A,
            SWAP12 => 0x9B,
            SWAP13 => 0x9C,
            SWAP14 => 0x9D,
            SWAP15 => 0x9E,
            SWAP16 => 0x9F,
            LOG0 => 0xA0,
            LOG1 => 0xA1,
            LOG2 => 0xA2,
            LOG3 => 0xA3,
            LOG4 => 0xA4,
            CREATE => 0xF0,
            CALL => 0xF1,
            CALLCODE => 0xF2,
            RETURN => 0xF3,
            DELEGATECALL => 0xF4,
            CREATE2 => 0xF5,
            STATICCALL => 0xFA,
            REVERT => 0xFD,
            INVALID => 0xFE,
            SELFDESTRUCT => 0xFF,
            UNKNOWN(b) => *b,
        }
    }

    pub fn len(&self) -> usize {
        match self {
            PUSH1(_) => 2,
            PUSH2(_) => 3,
            PUSH3(_) => 4,
            PUSH4(_) => 5,
            PUSH5(_) => 6,
            PUSH6(_) => 7,
            PUSH7(_) => 8,
            PUSH8(_) => 9,
            PUSH9(_) => 10,
            PUSH10(_) => 11,
            PUSH11(_) => 12,
            PUSH12(_) => 13,
            PUSH13(_) => 14,
            PUSH14(_) => 15,
            PUSH15(_) => 16,
            PUSH16(_) => 17,
            PUSH17(_) => 18,
            PUSH18(_) => 19,
            PUSH19(_) => 20,
            PUSH20(_) => 21,
            PUSH21(_) => 22,
            PUSH22(_) => 23,
            PUSH23(_) => 24,
            PUSH24(_) => 25,
            PUSH25(_) => 26,
            PUSH26(_) => 27,
            PUSH27(_) => 28,
            PUSH28(_) => 29,
            PUSH29(_) => 30,
            PUSH30(_) => 31,
            PUSH31(_) => 32,
            PUSH32(_) => 33,
            _ => 1,
        }
    }

    pub fn is_empty(&self) -> bool {
        false
    }

    pub fn append_to(&self, stream: &mut Vec<u8>) {
        stream.push(self.byte());

        push_extra_data!(
            self, stream, PUSH1, PUSH2, PUSH3, PUSH4, PUSH5, PUSH6, PUSH7, PUSH8, PUSH9, PUSH10,
            PUSH11, PUSH12, PUSH13, PUSH14, PUSH15, PUSH16, PUSH17, PUSH18, PUSH19, PUSH20, PUSH21,
            PUSH22, PUSH23, PUSH24, PUSH25, PUSH26, PUSH27, PUSH28, PUSH29, PUSH30, PUSH31, PUSH32
        );
    }
}

impl fmt::Display for Opcode {
    push_match_formats!(
        PUSH1, PUSH2, PUSH3, PUSH4, PUSH5, PUSH6, PUSH7, PUSH8, PUSH9, PUSH10, PUSH11, PUSH12,
        PUSH13, PUSH14, PUSH15, PUSH16, PUSH17, PUSH18, PUSH19, PUSH20, PUSH21, PUSH22, PUSH23,
        PUSH24, PUSH25, PUSH26, PUSH27, PUSH28, PUSH29, PUSH30, PUSH31, PUSH32
    );
}
